# /// script
# requires-python = ">=3.10"
# dependencies = [
#   "nox[uv]>=2025.2.9",
# ]
# ///
"""Task automation with Nox."""

from __future__ import annotations

import os
from pathlib import Path

import nox

nox.needs_version = ">=2025.2.9"
nox.options.default_venv_backend = "uv"
nox.options.reuse_existing_virtualenvs = True
nox.options.sessions = (
    "lint",
    "typecheck",
{%- if docs %}
    "docs",
{%- endif %}
    "tests",
)

PYPROJECT = nox.project.load_toml()
PROJECT_NAME = PYPROJECT["project"]["name"]
SUPPORTED_PYTHON_VERSIONS = nox.project.python_versions(PYPROJECT)
DEFAULT_PYTHON_VERSION = Path(".python-version").read_text().rstrip()


@nox.session(python=SUPPORTED_PYTHON_VERSIONS, tags=["tests"])
def tests(session: nox.Session) -> None:
    """Run the test suite."""
{%- if install == 'uv pip' %}
    session.install(".")
    session.install(*nox.project.dependency_groups(PYPROJECT, "tests"))
{%- else %}
    session.run_install(
        "uv",
        "sync",
        "--locked",
        "--no-editable",
        f"--reinstall-package={PROJECT_NAME}",
        "--no-default-groups",
        "--group=tests",
        f"--python={session.virtualenv.location}",
        env={"UV_PROJECT_ENVIRONMENT": session.virtualenv.location},
    )
{%- endif %}
    tmp_dir = Path(session.create_tmp())
    session.env["COVERAGE_FILE"] = os.getenv("COVERAGE_FILE") or str(
        tmp_dir / ".coverage"
    )
    session.run("coverage", "erase")
    session.run(
        "coverage",
        "run",
        "-m",
        "pytest",
        *(
            session.posargs
            or (
                "--durations",
                "15",
                "-n",
                os.getenv("PYTEST_XDIST_AUTO_NUM_WORKERS") or "auto",
            )
        ),
    )
    session.run("coverage", "combine")
    session.run("coverage", "report")


@nox.session(python=DEFAULT_PYTHON_VERSION, tags=["checks"])
def lint(session: nox.Session) -> None:
    """Run pre-commit linting."""
{%- if install == 'uv pip' %}
    session.install(*nox.project.dependency_groups(PYPROJECT, "lint"))
{%- else %}
    session.run_install(
        "uv",
        "sync",
        "--locked",
        "--only-group=lint",
        f"--python={session.virtualenv.location}",
        env={"UV_PROJECT_ENVIRONMENT": session.virtualenv.location},
    )
{%- endif %}
    session.run(
        "pre-commit",
        "run",
        "--all-files",
        *session.posargs,
        env={"FORCE_PRE_COMMIT_UV_PATCH": "1"},
    )


@nox.session(python=DEFAULT_PYTHON_VERSION, tags=["checks"])
def typecheck(session: nox.Session) -> None:
    """Typecheck Python code."""
{%- if install == 'uv pip' %}
    session.install(".")
    session.install(*nox.project.dependency_groups(PYPROJECT, "type"))
{%- else %}
    session.run_install(
        "uv",
        "sync",
        "--locked",
        "--no-editable",
        f"--reinstall-package={PROJECT_NAME}",
        "--no-default-groups",
        "--group=type",
        f"--python={session.virtualenv.location}",
        env={"UV_PROJECT_ENVIRONMENT": session.virtualenv.location},
    )
{%- endif %}
    session.run(*(session.posargs or ("mypy", "src", "tests")))

{% if docs == 'mkdocs' %}
@nox.session(python=DEFAULT_PYTHON_VERSION, tags=["checks"])
def docs(session: nox.Session) -> None:
    """Generate the documentation."""
{%- if install == 'uv pip' %}
    session.install("-e", ".")
    session.install(*nox.project.dependency_groups(PYPROJECT, "docs"))
{%- else %}
    session.run_install(
        "uv",
        "sync",
        "--locked",
        "--no-editable",
        f"--reinstall-package={PROJECT_NAME}",
        "--no-default-groups",
        "--group=docs",
        f"--python={session.virtualenv.location}",
        env={"UV_PROJECT_ENVIRONMENT": session.virtualenv.location},
    )
{%- endif %}
    tmp_dir = Path(session.create_tmp())
    session.run(
        "mkdocs",
        "build",
        "--clean",
        "--strict",
        "--site-dir",
        tmp_dir,
        *session.posargs,
    )


@nox.session(python=DEFAULT_PYTHON_VERSION)
def autodocs(session: nox.Session) -> None:
    """Serve the documentation locally."""
{%- if install == 'uv pip' %}
    session.install("-e", ".")
    session.install(*nox.project.dependency_groups(PYPROJECT, "docs"))
{%- else %}
    session.run_install(
        "uv",
        "sync",
        "--locked",
        "--no-default-groups",
        "--group=docs",
        f"--python={session.virtualenv.location}",
        env={"UV_PROJECT_ENVIRONMENT": session.virtualenv.location},
    )
{%- endif %}
    session.run(
        "mkdocs",
        "serve",
        "--strict",
        "--open",
        *session.posargs,
    )

{% endif %}
if __name__ == "__main__":
    nox.main()

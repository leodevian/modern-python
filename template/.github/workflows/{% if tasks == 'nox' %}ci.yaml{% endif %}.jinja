---
name: CI

on:
  push:
    branches: [main]
    tags-ignore: ["**"]
  pull_request: null
  workflow_dispatch: null

concurrency:
  group: {% raw %}${{ github.workflow }}-${{ github.ref }}{% endraw %}
  cancel-in-progress: true

permissions: {}

jobs:
  check:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        session:
          - lint
          - typecheck
{%- if docs %}
          - docs
{%- endif %}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          github-token: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
      - name: Install Nox
        run: >-
          uv tool install nox
          --python-preference only-managed
          --python 3.14
      - name: Set up {% raw %}${{ matrix.session }}{% endraw %}
        run: >-
          nox
          --install-only
          --error-on-missing-interpreters
          --session {% raw %}${{ matrix.session }}{% endraw %}
      - name: Run {% raw %}${{ matrix.session }}{% endraw %}
        run: >-
          nox
          --no-install
          --session {% raw %}${{ matrix.session }}{% endraw %}

  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python_version:
          - '3.14'
          - '3.13'
          - '3.12'
          - '3.11'
          - '3.10'
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          github-token: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
      - name: Install Nox
        run: >-
          uv tool install nox
          --python-preference only-managed
          --python 3.14
      - name: Set up the test suite
        run: >-
          nox
          --install-only
          --error-on-missing-interpreters
          --session {% raw %}tests-${{ matrix.python_version }}{% endraw %}
      - name: Run the test suite
        run: >-
          nox
          --no-install
          --session {% raw %}tests-${{ matrix.python_version }}{% endraw %}
